{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __classPrivateFieldSet = this && this.__classPrivateFieldSet || function (receiver, state, value, kind, f) {\n  if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\n  return kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value), value;\n};\n\nvar __classPrivateFieldGet = this && this.__classPrivateFieldGet || function (receiver, state, kind, f) {\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n  return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n};\n\nvar _QueryIntegration_instances, _QueryIntegration_api, _QueryIntegration_defaults, _QueryIntegration_setQueryDefaults, _QueryIntegration_createQuery, _QueryIntegration_getQueryResult;\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.QueryIntegration = void 0;\n\nconst types_1 = require(\"../../types\");\n\nconst sleep_1 = require(\"../../utils/sleep\");\n\nconst errors_1 = require(\"../../errors\");\n\nconst query_result_set_builder_1 = require(\"./query-result-set-builder\");\n\nconst DEFAULTS = {\n  ttlMinutes: 60,\n  cached: true,\n  timeoutMinutes: 20,\n  retryIntervalSeconds: 0.5,\n  pageSize: 100000,\n  pageNumber: 1\n};\n\nclass QueryIntegration {\n  constructor(api, defaults = DEFAULTS) {\n    _QueryIntegration_instances.add(this);\n\n    _QueryIntegration_api.set(this, void 0);\n\n    _QueryIntegration_defaults.set(this, void 0);\n\n    __classPrivateFieldSet(this, _QueryIntegration_api, api, \"f\");\n\n    __classPrivateFieldSet(this, _QueryIntegration_defaults, defaults, \"f\");\n  }\n\n  run(query) {\n    return __awaiter(this, void 0, void 0, function* () {\n      query = __classPrivateFieldGet(this, _QueryIntegration_instances, \"m\", _QueryIntegration_setQueryDefaults).call(this, query);\n      const [createQueryJson, createQueryErr] = yield __classPrivateFieldGet(this, _QueryIntegration_instances, \"m\", _QueryIntegration_createQuery).call(this, query);\n\n      if (createQueryErr) {\n        return new query_result_set_builder_1.QueryResultSetBuilder({\n          queryResultJson: null,\n          error: createQueryErr\n        });\n      }\n\n      if (!createQueryJson) {\n        return new query_result_set_builder_1.QueryResultSetBuilder({\n          queryResultJson: null,\n          error: new errors_1.UnexpectedSDKError(\"expected a `createQueryJson` but got null\")\n        });\n      }\n\n      const [getQueryResultJson, getQueryErr] = yield __classPrivateFieldGet(this, _QueryIntegration_instances, \"m\", _QueryIntegration_getQueryResult).call(this, createQueryJson.token, query.pageNumber || 1, query.pageSize || 100000);\n\n      if (getQueryErr) {\n        return new query_result_set_builder_1.QueryResultSetBuilder({\n          queryResultJson: null,\n          error: getQueryErr\n        });\n      }\n\n      if (!getQueryResultJson) {\n        return new query_result_set_builder_1.QueryResultSetBuilder({\n          queryResultJson: null,\n          error: new errors_1.UnexpectedSDKError(\"expected a `getQueryResultJson` but got null\")\n        });\n      }\n\n      return new query_result_set_builder_1.QueryResultSetBuilder({\n        queryResultJson: getQueryResultJson,\n        error: null\n      });\n    });\n  }\n\n}\n\nexports.QueryIntegration = QueryIntegration;\n_QueryIntegration_api = new WeakMap(), _QueryIntegration_defaults = new WeakMap(), _QueryIntegration_instances = new WeakSet(), _QueryIntegration_setQueryDefaults = function _QueryIntegration_setQueryDefaults(query) {\n  return Object.assign(Object.assign({}, __classPrivateFieldGet(this, _QueryIntegration_defaults, \"f\")), query);\n}, _QueryIntegration_createQuery = function _QueryIntegration_createQuery(query, attempts = 0) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const resp = yield __classPrivateFieldGet(this, _QueryIntegration_api, \"f\").createQuery(query);\n\n    if (resp.statusCode <= 299) {\n      return [resp.data, null];\n    }\n\n    if (resp.statusCode !== 429) {\n      if (resp.statusCode >= 400 && resp.statusCode <= 499) {\n        let errorMsg = resp.statusMsg || \"user error\";\n\n        if (resp.errorMsg) {\n          errorMsg = resp.errorMsg;\n        }\n\n        return [null, new errors_1.UserError(resp.statusCode, errorMsg)];\n      }\n\n      return [null, new errors_1.ServerError(resp.statusCode, resp.statusMsg || \"server error\")];\n    }\n\n    let shouldContinue = yield (0, sleep_1.expBackOff)({\n      attempts,\n      timeoutMinutes: __classPrivateFieldGet(this, _QueryIntegration_defaults, \"f\").timeoutMinutes,\n      intervalSeconds: __classPrivateFieldGet(this, _QueryIntegration_defaults, \"f\").retryIntervalSeconds\n    });\n\n    if (!shouldContinue) {\n      return [null, new errors_1.QueryRunRateLimitError()];\n    }\n\n    return __classPrivateFieldGet(this, _QueryIntegration_instances, \"m\", _QueryIntegration_createQuery).call(this, query, attempts + 1);\n  });\n}, _QueryIntegration_getQueryResult = function _QueryIntegration_getQueryResult(queryID, pageNumber, pageSize, attempts = 0) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const resp = yield __classPrivateFieldGet(this, _QueryIntegration_api, \"f\").getQueryResult(queryID, pageNumber, pageSize);\n\n    if (resp.statusCode > 299) {\n      if (resp.statusCode >= 400 && resp.statusCode <= 499) {\n        let errorMsg = resp.statusMsg || \"user input error\";\n\n        if (resp.errorMsg) {\n          errorMsg = resp.errorMsg;\n        }\n\n        return [null, new errors_1.UserError(resp.statusCode, errorMsg)];\n      }\n\n      return [null, new errors_1.ServerError(resp.statusCode, resp.statusMsg || \"server error\")];\n    }\n\n    if (!resp.data) {\n      throw new Error(\"valid status msg returned from server but no data exists in the response\");\n    }\n\n    if (resp.data.status === types_1.QueryStatusFinished) {\n      return [resp.data, null];\n    }\n\n    if (resp.data.status === types_1.QueryStatusError) {\n      return [null, new errors_1.QueryRunExecutionError()];\n    }\n\n    let shouldContinue = yield (0, sleep_1.linearBackOff)({\n      attempts,\n      timeoutMinutes: __classPrivateFieldGet(this, _QueryIntegration_defaults, \"f\").timeoutMinutes,\n      intervalSeconds: __classPrivateFieldGet(this, _QueryIntegration_defaults, \"f\").retryIntervalSeconds\n    });\n\n    if (!shouldContinue) {\n      const elapsedSeconds = (0, sleep_1.getElapsedLinearSeconds)({\n        attempts,\n        timeoutMinutes: __classPrivateFieldGet(this, _QueryIntegration_defaults, \"f\").timeoutMinutes,\n        intervalSeconds: __classPrivateFieldGet(this, _QueryIntegration_defaults, \"f\").retryIntervalSeconds\n      });\n      return [null, new errors_1.QueryRunTimeoutError(elapsedSeconds * 60)];\n    }\n\n    return __classPrivateFieldGet(this, _QueryIntegration_instances, \"m\", _QueryIntegration_getQueryResult).call(this, queryID, pageNumber, pageSize, attempts + 1);\n  });\n}; //# sourceMappingURL=index.js.map","map":null,"metadata":{},"sourceType":"script"}